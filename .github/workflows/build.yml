name: Security Scans

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  sast-scan:
    name: Static Code & Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install PHP & Dependencies
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring, xml, bcmath
          tools: composer

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run Larastan (Laravel SAST)
        run: |
          composer require --dev nunomaduro/larastan
          ./vendor/bin/phpstan analyse --level=5 app

      - name: Run Semgrep (Generic SAST)
        uses: returntocorp/semgrep-action@v1
        with:
          config: "auto"

      - name: Run Gitleaks (Secret Scanner)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: community
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
